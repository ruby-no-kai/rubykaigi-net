{
  "apiVersion": "v1",
  "data": {
    "unbound.conf": "server:\n  do-daemonize: no\n  chroot: \"\"\n  username: \"unbound\"\n  logfile: \"\"  # stderr\n  verbosity: 2\n  extended-statistics: yes\n  log-servfail: yes\n  val-log-level: 2\n\n  interface: 0.0.0.0@10053\n  interface: 0.0.0.0@10853\n  interface: 0.0.0.0@10443\n  port: 10053\n  tls-port: 10853\n  https-port: 10443\n  access-control: 10.33.0.0/16 allow\n\n  do-ip4: yes\n  do-ip6: no\n\n  tls-service-key: /secrets/tls-cert/tls.key\n  tls-service-pem: /secrets/tls-cert/tls.crt\n\n  root-hints: /usr/share/dns/root.hints\n  trust-anchor-file: /var/lib/unbound/root.key\n\n  prefetch: yes\n  prefetch-key: yes\n\n  # https://nlnetlabs.nl/documentation/unbound/howto-optimise/\n  num-threads: 2\n  num-queries-per-thread: 4096\n  outgoing-range: 8192\n\n  msg-cache-slabs: 2\n  rrset-cache-slabs: 2\n  infra-cache-slabs: 2\n  key-cache-slabs: 2\n\n  rrset-cache-size: 400m\n  msg-cache-size: 200m\n\n  so-rcvbuf: 4m\n  so-sndbuf: 4m\n  so-reuseport: yes\n\n  local-zone: 10.in-addr.arpa. nodefault\n  local-zone: a.c.0.0.5.8.0.f.d.0.1.0.0.2.ip6.arpa. nodefault\n  domain-insecure: 10.in-addr.arpa.\n  domain-insecure: a.c.0.0.5.8.0.f.d.0.1.0.0.2.ip6.arpa.\n\nforward-zone:\n  name: 10.in-addr.arpa.\n  forward-addr: 169.254.169.253\n\nforward-zone:\n  name: a.c.0.0.5.8.0.f.d.0.1.0.0.2.ip6.arpa.\n  forward-addr: 169.254.169.253\n\nforward-zone:\n  name: rubykaigi.net.\n  forward-addr: 169.254.169.253\n\nforward-zone:\n  name: rubykaigi.org.\n  forward-addr: 169.254.169.253\n\nremote-control:\n  control-enable: yes\n  control-interface: /run/unbound.ctl\n"
  },
  "kind": "ConfigMap",
  "metadata": {
    "name": "unbound-config"
  }
}
---
{
  "apiVersion": "v1",
  "data": {
    "envoy.json": "{\n    \"admin\": {\n        \"address\": {\n            \"socket_address\": {\n                \"address\": \"0.0.0.0\",\n                \"port_value\": 9901\n            }\n        }\n    },\n    \"layered_runtime\": {\n        \"layers\": [\n            {\n                \"name\": \"static\",\n                \"static_layer\": {\n                    \"envoy\": {\n                        \"resource_limits\": {\n                            \"listener\": {\n                                \"tcp\": {\n                                    \"connection_limit\": 2000\n                                },\n                                \"udp\": {\n                                    \"connection_limit\": 2000\n                                }\n                            }\n                        }\n                    },\n                    \"overload\": {\n                        \"global_downstream_max_connections\": 2000\n                    }\n                }\n            }\n        ]\n    },\n    \"overload_manager\": {\n        \"actions\": [\n            {\n                \"name\": \"envoy.overload_actions.shrink_heap\",\n                \"triggers\": [\n                    {\n                        \"name\": \"envoy.resource_monitors.fixed_heap\",\n                        \"threshold\": {\n                            \"value\": 0.94999999999999996\n                        }\n                    }\n                ]\n            },\n            {\n                \"name\": \"envoy.overload_actions.stop_accepting_requests\",\n                \"triggers\": [\n                    {\n                        \"name\": \"envoy.resource_monitors.fixed_heap\",\n                        \"threshold\": {\n                            \"value\": 0.97999999999999998\n                        }\n                    }\n                ]\n            }\n        ],\n        \"refresh_interval\": \"0.25s\",\n        \"resource_monitors\": [\n            {\n                \"name\": \"envoy.resource_monitors.fixed_heap\",\n                \"typed_config\": {\n                    \"@type\": \"type.googleapis.com/envoy.extensions.resource_monitors.fixed_heap.v3.FixedHeapConfig\",\n                    \"max_heap_size_bytes\": 524288000\n                }\n            }\n        ]\n    },\n    \"static_resources\": {\n        \"clusters\": [\n            {\n                \"connect_timeout\": \"0.25s\",\n                \"load_assignment\": {\n                    \"cluster_name\": \"unbound\",\n                    \"endpoints\": [\n                        {\n                            \"lb_endpoints\": [\n                                {\n                                    \"endpoint\": {\n                                        \"address\": {\n                                            \"socket_address\": {\n                                                \"address\": \"unbound.default.svc.cluster.local\",\n                                                \"port_value\": 443\n                                            }\n                                        }\n                                    }\n                                }\n                            ]\n                        }\n                    ]\n                },\n                \"name\": \"unbound\",\n                \"per_connection_buffer_limit_bytes\": 32768,\n                \"transport_socket\": {\n                    \"name\": \"envoy.transport_sockets.tls\",\n                    \"typed_config\": {\n                        \"@type\": \"type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext\",\n                        \"common_tls_context\": {\n                            \"validation_context\": {\n                                \"match_typed_subject_alt_names\": [\n                                    {\n                                        \"matcher\": {\n                                            \"exact\": \"resolver.rubykaigi.net\"\n                                        },\n                                        \"san_type\": \"DNS\"\n                                    }\n                                ],\n                                \"trusted_ca\": {\n                                    \"filename\": \"/etc/ssl/certs/ca-certificates.crt\"\n                                }\n                            }\n                        },\n                        \"sni\": \"resolver.rubykaigi.net\"\n                    }\n                },\n                \"type\": \"LOGICAL_DNS\",\n                \"typed_extension_protocol_options\": {\n                    \"envoy.extensions.upstreams.http.v3.HttpProtocolOptions\": {\n                        \"@type\": \"type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions\",\n                        \"explicit_http_config\": {\n                            \"http2_protocol_options\": {\n                                \"initial_connection_window_size\": 1048576,\n                                \"initial_stream_window_size\": 65536\n                            }\n                        }\n                    }\n                }\n            }\n        ],\n        \"listeners\": [\n            {\n                \"address\": {\n                    \"socket_address\": {\n                        \"address\": \"0.0.0.0\",\n                        \"port_value\": 11443,\n                        \"protocol\": \"TCP\"\n                    }\n                },\n                \"filter_chains\": [\n                    {\n                        \"filters\": [\n                            {\n                                \"name\": \"envoy.filters.network.http_connection_manager\",\n                                \"typed_config\": {\n                                    \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\",\n                                    \"access_log\": [\n                                        {\n                                            \"name\": \"envoy.access_loggers.file\",\n                                            \"typed_config\": {\n                                                \"@type\": \"type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog\",\n                                                \"path\": \"/dev/stdout\"\n                                            }\n                                        }\n                                    ],\n                                    \"codec_type\": \"AUTO\",\n                                    \"common_http_protocol_options\": {\n                                        \"headers_with_underscores_action\": \"REJECT_REQUEST\",\n                                        \"idle_timeout\": \"3600s\"\n                                    },\n                                    \"http2_protocol_options\": {\n                                        \"initial_connection_window_size\": 1048576,\n                                        \"initial_stream_window_size\": 65536,\n                                        \"max_concurrent_streams\": 100\n                                    },\n                                    \"http_filters\": [\n                                        {\n                                            \"name\": \"envoy.filters.http.router\",\n                                            \"typed_config\": {\n                                                \"@type\": \"type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\"\n                                            }\n                                        }\n                                    ],\n                                    \"merge_slashes\": true,\n                                    \"normalize_path\": true,\n                                    \"path_with_escaped_slashes_action\": \"UNESCAPE_AND_REDIRECT\",\n                                    \"request_timeout\": \"300s\",\n                                    \"route_config\": {\n                                        \"virtual_hosts\": [\n                                            {\n                                                \"domains\": [\n                                                    \"*\"\n                                                ],\n                                                \"name\": \"default\",\n                                                \"routes\": [\n                                                    {\n                                                        \"match\": {\n                                                            \"path\": \"/dns-query\"\n                                                        },\n                                                        \"name\": \"dns-query\",\n                                                        \"route\": {\n                                                            \"cluster\": \"unbound\"\n                                                        }\n                                                    }\n                                                ]\n                                            }\n                                        ]\n                                    },\n                                    \"stat_prefix\": \"ingress_http_tcp\",\n                                    \"stream_idle_timeout\": \"300s\",\n                                    \"use_remote_address\": true\n                                }\n                            }\n                        ],\n                        \"transport_socket\": {\n                            \"name\": \"envoy.transport_sockets.tls\",\n                            \"typed_config\": {\n                                \"@type\": \"type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext\",\n                                \"common_tls_context\": {\n                                    \"alpn_protocols\": [\n                                        \"h2\",\n                                        \"http/1.1\"\n                                    ],\n                                    \"tls_certificates\": [\n                                        {\n                                            \"certificate_chain\": {\n                                                \"filename\": \"/secrets/tls-cert/tls.crt\"\n                                            },\n                                            \"private_key\": {\n                                                \"filename\": \"/secrets/tls-cert/tls.key\"\n                                            }\n                                        }\n                                    ],\n                                    \"tls_params\": {\n                                        \"tls_minimum_protocol_version\": \"TLSv1_3\"\n                                    }\n                                }\n                            }\n                        }\n                    }\n                ],\n                \"listener_filters\": [\n                    {\n                        \"name\": \"envoy.filters.listener.tls_inspector\",\n                        \"typed_config\": {\n                            \"@type\": \"type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector\"\n                        }\n                    },\n                    {\n                        \"name\": \"envoy.filters.listener.http_inspector\",\n                        \"typed_config\": {\n                            \"@type\": \"type.googleapis.com/envoy.extensions.filters.listener.http_inspector.v3.HttpInspector\"\n                        }\n                    }\n                ],\n                \"name\": \"tcp\",\n                \"per_connection_buffer_limit_bytes\": 32768\n            },\n            {\n                \"address\": {\n                    \"socket_address\": {\n                        \"address\": \"0.0.0.0\",\n                        \"port_value\": 11443,\n                        \"protocol\": \"UDP\"\n                    }\n                },\n                \"filter_chains\": [\n                    {\n                        \"filters\": [\n                            {\n                                \"name\": \"envoy.filters.network.http_connection_manager\",\n                                \"typed_config\": {\n                                    \"@type\": \"type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager\",\n                                    \"access_log\": [\n                                        {\n                                            \"name\": \"envoy.access_loggers.file\",\n                                            \"typed_config\": {\n                                                \"@type\": \"type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog\",\n                                                \"path\": \"/dev/stdout\"\n                                            }\n                                        }\n                                    ],\n                                    \"codec_type\": \"HTTP3\",\n                                    \"common_http_protocol_options\": {\n                                        \"headers_with_underscores_action\": \"REJECT_REQUEST\",\n                                        \"idle_timeout\": \"3600s\"\n                                    },\n                                    \"http2_protocol_options\": {\n                                        \"initial_connection_window_size\": 1048576,\n                                        \"initial_stream_window_size\": 65536,\n                                        \"max_concurrent_streams\": 100\n                                    },\n                                    \"http_filters\": [\n                                        {\n                                            \"name\": \"envoy.filters.http.router\",\n                                            \"typed_config\": {\n                                                \"@type\": \"type.googleapis.com/envoy.extensions.filters.http.router.v3.Router\"\n                                            }\n                                        }\n                                    ],\n                                    \"merge_slashes\": true,\n                                    \"normalize_path\": true,\n                                    \"path_with_escaped_slashes_action\": \"UNESCAPE_AND_REDIRECT\",\n                                    \"request_timeout\": \"300s\",\n                                    \"route_config\": {\n                                        \"virtual_hosts\": [\n                                            {\n                                                \"domains\": [\n                                                    \"*\"\n                                                ],\n                                                \"name\": \"default\",\n                                                \"routes\": [\n                                                    {\n                                                        \"match\": {\n                                                            \"path\": \"/dns-query\"\n                                                        },\n                                                        \"name\": \"dns-query\",\n                                                        \"route\": {\n                                                            \"cluster\": \"unbound\"\n                                                        }\n                                                    }\n                                                ]\n                                            }\n                                        ]\n                                    },\n                                    \"stat_prefix\": \"ingress_http_udp\",\n                                    \"stream_idle_timeout\": \"300s\",\n                                    \"use_remote_address\": true\n                                }\n                            }\n                        ],\n                        \"transport_socket\": {\n                            \"name\": \"envoy.transport_sockets.quic\",\n                            \"typed_config\": {\n                                \"@type\": \"type.googleapis.com/envoy.extensions.transport_sockets.quic.v3.QuicDownstreamTransport\",\n                                \"downstream_tls_context\": {\n                                    \"common_tls_context\": {\n                                        \"tls_certificates\": [\n                                            {\n                                                \"certificate_chain\": {\n                                                    \"filename\": \"/secrets/tls-cert/tls.crt\"\n                                                },\n                                                \"private_key\": {\n                                                    \"filename\": \"/secrets/tls-cert/tls.key\"\n                                                }\n                                            }\n                                        ]\n                                    }\n                                }\n                            }\n                        }\n                    }\n                ],\n                \"name\": \"udp\",\n                \"per_connection_buffer_limit_bytes\": 32768,\n                \"udp_listener_config\": {\n                    \"downstream_socket_config\": {\n                        \"prefer_gro\": true\n                    },\n                    \"quic_options\": {\n\n                    }\n                }\n            }\n        ]\n    }\n}"
  },
  "kind": "ConfigMap",
  "metadata": {
    "name": "envoy-config"
  }
}
---
